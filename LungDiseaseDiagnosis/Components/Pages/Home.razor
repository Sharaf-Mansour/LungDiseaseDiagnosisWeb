@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using LungDiseaseDiagnosis.Models
@using LungDiseaseDiagnosis.Services
@inject IUserService UserService
@inject NavigationManager NavigationManager

<PageTitle>Home</PageTitle>

@if (UserService.CurrentUser is not null)
{
    @if (UserService.CurrentUser.Type == MedType.Doctor)
    {
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-10 text-center">
                    <h1 class="display-5 fw-bold">Doctor Dashboard</h1>
                    <p class="lead text-muted mb-5">Welcome, @UserService.CurrentUser.Name</p>
                    <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                        <button class="btn btn-primary btn-lg" @onclick='() => NavigationManager.NavigateTo("/review-report")'>
                            <i class="bi bi-clipboard2-pulse"></i> Review Report
                        </button>
                        <button class="btn btn-info btn-lg"
                            @onclick='() => NavigationManager.NavigateTo("/medical-image-analysis")'>
                            <i class="bi bi-cloud-upload"></i> Upload Image
                        </button>
                        <button class="btn btn-secondary btn-lg" @onclick='() => NavigationManager.NavigateTo("/results")'>
                            <i class="bi bi-card-list"></i> View All Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (UserService.CurrentUser.Type == MedType.Nurse)
    {
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-10 text-center">
                    <h1 class="display-5 fw-bold">Nurse Dashboard</h1>
                    <p class="lead text-muted mb-5">Welcome, @UserService.CurrentUser.Name</p>
                    <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                        <button class="btn btn-primary btn-lg" @onclick='() => NavigationManager.NavigateTo("/general-notes")'>
                            <i class="bi bi-pencil-square"></i> Write General Notes
                        </button>
                        <button class="btn btn-info btn-lg"
                            @onclick='() => NavigationManager.NavigateTo("/medical-image-analysis")'>
                            <i class="bi bi-cloud-upload"></i> Upload Image
                        </button>
                        <button class="btn btn-secondary btn-lg"
                            @onclick='() => NavigationManager.NavigateTo("/track-report-state")'>
                            <i class="bi bi-graph-up"></i> Track Report State
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-10 text-center">
                    <h1 class="display-5 fw-bold">Welcome, @UserService.CurrentUser.Name</h1>
                    <p class="lead text-muted mb-5">You are logged in as a @UserService.CurrentUser.Type.</p>
                </div>
            </div>
        </div>
    }
}
else
{
    // This part is rendered during the initial load before the check is complete.
    // It can be left empty or show a loading indicator.
}

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // A small delay to allow NavMenu to potentially load the user from storage first.
            await Task.Delay(1);
            if (UserService.CurrentUser == null)
            {
                NavigationManager.NavigateTo("/login");
            }
            else
            {
                // If the user is loaded, trigger a re-render to show the correct dashboard.
                StateHasChanged();
            }
        }
    }
}